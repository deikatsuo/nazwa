/* Nazwa
*  Membuat tabel utama
*  Authored by Deri Herdianto
*  c 2020
*/

-- DROP semua
DROP TABLE IF EXISTS "user_role";
DROP TABLE IF EXISTS "role";
DROP TABLE IF EXISTS "email";
DROP TABLE IF EXISTS "phone";
DROP TABLE IF EXISTS "user";
DROP TYPE IF EXISTS "gender";

-- Tabel role/peran
CREATE TABLE "role" (
    "id" SMALLINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    "name" VARCHAR(10) NOT NULL,
    PRIMARY KEY (id)
);

-- Buat peran
INSERT INTO "role" ("id", "name")
VALUES  (1, 'admin'),
        (2, 'surveyer'),
        (3, 'collector'),
        (4, 'sales'),
        (5, 'customer');

-- Buat gender
CREATE TYPE "gender" AS ENUM ('f', 'm');

-- Tabel user/pengguna
CREATE TABLE "user" (
    "id" INT GENERATED ALWAYS AS IDENTITY NOT NULL,
    "first_name" VARCHAR(25) NOT NULL,
    "last_name" VARCHAR(25),
    "username" VARCHAR(25) UNIQUE,
    "password" CHAR(100),
    "password_salt" CHAR(100),
    "gender" GENDER NOT NULL,
    "created_at" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    "balance" DECIMAL(15,2) DEFAULT '0',
    PRIMARY KEY (id)
);

-- Tabel peran user/pengguna
CREATE TABLE "user_role" (
    "id" INT GENERATED ALWAYS AS IDENTITY NOT NULL,
    "role_id" INT NOT NULL,
    "user_id" INT UNIQUE NOT NULL,
    PRIMARY KEY (id),
    FOREIGN KEY (role_id) REFERENCES "role"("id"),
    FOREIGN KEY (user_id) REFERENCES "user"("id")
);

-- Tabel email
-- Pengguna boleh memiliki beberapa email
CREATE TABLE "email" (
    "id" INT GENERATED ALWAYS AS IDENTITY NOT NULL,
    "user_id" INT NOT NULL,
    "email" VARCHAR(60) UNIQUE NOT NULL,
    PRIMARY KEY (id),
    FOREIGN KEY (user_id) REFERENCES "user"("id")
);

-- Tabel nomor HP
-- Pengguna boleh memiliki lebih dari satu nomor HP
CREATE TABLE "phone" (
    "id" INT GENERATED ALWAYS AS IDENTITY NOT NULL,
    "user_id" INT NOT NULL,
    "phone" NUMERIC(12,0) UNIQUE NOT NULL,
    PRIMARY KEY (id),
    FOREIGN KEY (user_id) REFERENCES "user"("id")
);