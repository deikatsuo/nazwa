{{ define "dashboard_products_detail_modal" }}
<template x-ref="productDetail">
  <div x-init="fetchById($dispatch)" x-data="fProDetail($parent)">
    <!-- Title -->
    <div
      class="
        absolute
        top-0
        mt-3
        ml-3
        sm:mr-0
        text-sm
        md:text-lg
        font-semibold
        tracking-wide
        text-left text-gray-500
        dark:text-gray-400
      "
      x-text="product.Name"
    ></div>
    <!-- Photo produk -->
    <div
      class="w-full h-48 flex flex-col justify-center items-center"
      :class="{ 'mb-4': photos.length > 1 }"
    >
      <div class="w-full relative">
        <!-- Slide photo -->
        <template x-for="(photo, index) in photos" :key="index">
          <div>
            <div
              x-show="activeSlide === index + 1"
              class="h-48 w-full flex items-center rounded-lg"
            >
              <div class="relative w-full h-full cursor-pointer">
                <img
                  class="object-scale-down w-full h-full"
                  :src="'/file/product/'+photo.Photo"
                  alt=""
                  loading="lazy"
                />
                <div
                  class="absolute inset-0 shadow-inner"
                  aria-hidden="true"
                ></div>
              </div>
              <div
                x-show="selectedPhoto === photo.ID"
                class="absolute h-full w-full bg-black bg-opacity-75"
              ></div>
            </div>
            <div
              class="absolute inset-0 mx-5 z-10 cursor-pointer"
              x-show="activeSlide === index + 1"
              @click="$dispatch('preview', {
                    html: '<img @click=\'closePreview()\' src=\'/file/product/'+photo.Photo+'\' class=\'object-scale-down object w-full h-full lazy\' />',
                    });"
              @contextmenu.prevent="if (photo.ID > 0) { if (selectedPhoto === photo.ID) { selectedPhoto = null; } else { selectedPhoto = photo.ID; } }"
            ></div>
            <div
              class="absolute inset-0 mx-5 z-10"
              x-show="selectedPhoto === photo.ID"
              @contextmenu.prevent="if (photo.ID > 0) { if (selectedPhoto === photo.ID) { selectedPhoto = null; } else { selectedPhoto = photo.ID; } }"
            >
              <div class="w-full h-full flex items-center justify-center">
                <button
                  class="
                    cursor-pointer
                    py-1
                    px-4
                    text-sm text-white
                    transition-colors
                    duration-150
                    bg-red-600
                    border border-transparent
                    rounded-r-sm
                    active:bg-red-600
                    hover:bg-red-700
                    focus:outline-none
                    focus:shadow-outline-purple
                  "
                  @click="deletePhoto($dispatch, index);"
                >
                  hapus
                </button>
              </div>
            </div>
          </div>
        </template>
        <!-- Prev/Next Arrows -->
        <div class="absolute inset-0 flex" x-show="photos.length > 1">
          <div class="flex items-center justify-start w-1/2">
            <button
              class="
                bg-teal-100
                text-teal-500
                hover:text-orange-500
                font-bold
                hover:shadow-lg
                rounded-full
                w-12
                h-12
                -ml-6
              "
              x-on:click="activeSlide = activeSlide === 1 ? photos.length : activeSlide - 1"
            >
              &#8592;
            </button>
          </div>
          <div class="flex items-center justify-end w-1/2">
            <button
              class="
                bg-teal-100
                text-teal-500
                hover:text-orange-500
                font-bold
                hover:shadow
                rounded-full
                w-12
                h-12
                -mr-6
              "
              x-on:click="activeSlide = activeSlide === photos.length ? 1 : activeSlide + 1"
            >
              &#8594;
            </button>
          </div>
        </div>
        <!-- Buttons -->
        <div
          class="absolute w-full flex items-center justify-center px-4 mb-4"
          x-show="photos.length > 1"
        >
          <div>
            <template x-for="(_,index) in photos" :key="index">
              <button
                class="
                  flex-1
                  w-2
                  h-2
                  mt-4
                  mx-2
                  rounded-full
                  overflow-hidden
                  transition-colors
                  duration-200
                  ease-out
                  hover:bg-teal-600
                  hover:shadow-lg
                "
                :class="{ 
                        'bg-orange-600': activeSlide === index + 1,
                        'bg-teal-300': activeSlide !== index + 1 
                      }"
                x-on:click="activeSlide = index + 1"
              ></button>
            </template>
          </div>
        </div>
      </div>
    </div>
    <dl class="w-full whitespace-no-wrap">
      <div
        class="
          text-xs
          font-semibold
          tracking-wide
          text-left text-gray-900
          uppercase
          border-b
          dark:border-gray-700
          bg-gray-50
          dark:text-gray-400
          dark:bg-gray-800
        "
      >
        <dt class="px-3 py-3">Tambah Foto Produk</dt>
        <dd class="px-4 sm:px-0"></dd>
      </div>
      <div class="px-4 py-1">
        <div class="px-1">
          <!-- file upload modal -->
          <article
            aria-label="Photo Upload Modal"
            class="relative h-full flex flex-col"
          >
            <!-- scroll area -->
            <section class="h-full overflow-hidden p-6 w-full flex flex-col">
              <!-- Upload foto -->
              <ul class="flex flex-1 flex-wrap -m-1">
                <li class="block p-1 w-1/2 sm:w-1/3 md:w-1/4 h-24">
                  <article
                    tabindex="0"
                    class="
                      w-full
                      h-full
                      rounded-md
                      bg-gray-100
                      relative
                      text-transparent
                      hover:text-white
                      shadow-sm
                    "
                  >
                    <label class="mb-2">
                      <header
                        class="
                          cursor-pointer
                          rounded-md
                          relative
                          border-dashed border-2 border-gray-400
                          hover:border-orange-300
                          h-full
                          flex flex-col
                          justify-center
                          items-center
                        "
                      >
                        <input
                          @change="
                          for (const file of $event.target.files) {
                            if (file.type.match('image.*') && file.size > 0) {
                              base64(file);
                            } else {
                              $dispatch('notif', {
                                type: 'error',
                                message: 'File harus dalam format gambar .jpg, .png, etc. dan tidak rusak',
                              });
                            }
                          }"
                          type="file"
                          class="hidden"
                          multiple
                        />

                        <!-- overlay -->
                        <div
                          class="
                            w-full
                            h-full
                            absolute
                            top-0
                            left-0
                            pointer-events-none
                            z-10
                            flex flex-col
                            items-center
                            justify-center
                          "
                        >
                          <i>
                            <svg
                              class="fill-current w-12 h-12 mb-3 text-blue-700"
                              xmlns="http://www.w3.org/2000/svg"
                              width="24"
                              height="24"
                              viewBox="0 0 24 24"
                            >
                              <path
                                d="M19.479 10.092c-.212-3.951-3.473-7.092-7.479-7.092-4.005 0-7.267 3.141-7.479 7.092-2.57.463-4.521 2.706-4.521 5.408 0 3.037 2.463 5.5 5.5 5.5h13c3.037 0 5.5-2.463 5.5-5.5 0-2.702-1.951-4.945-4.521-5.408zm-7.479-1.092l4 4h-3v4h-2v-4h-3l4-4z"
                              />
                            </svg>
                          </i>
                        </div>
                      </header>
                    </label>
                  </article>
                </li>
                <template
                  x-for="(photo, index) in addPhoto.photos"
                  :key="index"
                >
                  <li class="block p-1 w-1/2 sm:w-1/3 md:w-1/4 h-24">
                    <article
                      tabindex="0"
                      class="
                        w-full
                        h-full
                        rounded-md
                        focus:outline-none
                        focus:shadow-outline
                        bg-gray-100
                        relative
                        text-transparent
                        hover:text-white
                        shadow-sm
                      "
                    >
                      <img
                        alt="upload preview"
                        class="
                          w-full
                          h-full
                          sticky
                          object-cover
                          rounded-md
                          bg-fixed
                        "
                        :src="photo.photo_type + ',' + photo.photo"
                      />

                      <section
                        class="
                          flex flex-col
                          rounded-md
                          text-xs
                          break-words
                          w-full
                          h-full
                          z-20
                          absolute
                          top-0
                          py-2
                          px-3
                          hover:bg-gray-400 hover:bg-opacity-75
                        "
                      >
                        <h1
                          x-text="photo.name"
                          class="flex-1 cursor-pointer"
                          @click="window.open(photo.photo_type + ',' + photo.photo, '_blank')"
                        ></h1>
                        <div class="flex">
                          <span class="p-1">
                            <i>
                              <svg
                                class="fill-current w-4 h-4 ml-auto pt-"
                                xmlns="http://www.w3.org/2000/svg"
                                width="24"
                                height="24"
                                viewBox="0 0 24 24"
                              >
                                <path
                                  d="M5 8.5c0-.828.672-1.5 1.5-1.5s1.5.672 1.5 1.5c0 .829-.672 1.5-1.5 1.5s-1.5-.671-1.5-1.5zm9 .5l-2.519 4-2.481-1.96-4 5.96h14l-5-8zm8-4v14h-20v-14h20zm2-2h-24v18h24v-18z"
                                />
                              </svg>
                            </i>
                          </span>

                          <p x-text="photo.size" class="p-1 size text-xs"></p>
                          <button
                            class="
                              ml-auto
                              focus:outline-none
                              hover:bg-grey-300
                              p-1
                              rounded-md
                            "
                            @click="delPhoto(index)"
                          >
                            <svg
                              class="
                                pointer-events-none
                                fill-current
                                w-4
                                h-4
                                ml-auto
                              "
                              xmlns="http://www.w3.org/2000/svg"
                              width="24"
                              height="24"
                              viewBox="0 0 24 24"
                            >
                              <path
                                class="pointer-events-none"
                                d="M3 6l3 18h12l3-18h-18zm19-4v2h-20v-2h5.711c.9 0 1.631-1.099 1.631-2h5.316c0 .901.73 2 1.631 2h5.711z"
                              />
                            </svg>
                          </button>
                        </div>
                      </section>
                    </article>
                  </li>
                </template>
              </ul>
            </section>
          </article>
        </div>
      </div>
      <div
        class="px-4 py-1 flex justify-center items-center"
        x-show="addPhoto.photos.length > 0"
      >
        <button
          class="
            px-4
            text-sm text-white
            transition-colors
            duration-150
            bg-purple-600
            border border-transparent
            rounded-r-sm
            active:bg-purple-600
            hover:bg-purple-700
            focus:outline-none
            focus:shadow-outline-purple
          "
          @click="addNewPhoto($dispatch)"
        >
          simpan
        </button>
      </div>
    </dl>

    <!-- Informasi Produk -->
    <dl class="w-full whitespace-no-wrap">
      <div
        class="
          text-xs
          font-semibold
          tracking-wide
          text-left text-gray-900
          uppercase
          border-b
          dark:border-gray-700
          bg-gray-50
          dark:text-gray-400
          dark:bg-gray-800
        "
      >
        <dt class="px-3 py-3">Informasi Produk</dt>
        <dd class="px-4 sm:px-0"></dd>
      </div>
      <div class="px-4 py-1 sm:grid sm:grid-cols-2">
        <dt class="text-sm leading-5 font-medium text-gray-500">Nama Barang</dt>
        <dd class="mt-1 text-sm leading-5 text-gray-900 sm:mt-0">
          <div
            class="w-full"
            x-text="product.Name"
            @dblclick="openUpdateForName($nextTick);"
            x-show="updateFor !== 'name'"
          ></div>
          <input
            class="
              block
              w-full
              mt-1
              text-sm
              dark:border-gray-600
              dark:bg-gray-700
              focus:outline-none
            "
            type="text"
            id="edit-name"
            x-model="updateData.name"
            x-show="updateFor == 'name'"
            @click.away="if (updateFor == 'name') { updateFor = ''; }"
            @keydown.enter="updateName($dispatch)"
          />
        </dd>
      </div>
      <div class="px-4 py-1 sm:grid sm:grid-cols-2">
        <dt class="text-sm leading-5 font-medium text-gray-500">Brand</dt>
        <dd class="mt-1 text-sm leading-5 text-gray-900 sm:mt-0">
          <div
            class="w-full"
            x-text="product.Brand"
            @dblclick="openUpdateForBrand($nextTick);"
            x-show="updateFor !== 'brand' && product.Brand !== ''"
          ></div>
          <div
            class="w-full"
            @dblclick="openUpdateForBrand($nextTick);"
            x-show="updateFor !== 'brand' && product.Brand === ''"
          >
            -
          </div>
          <input
            class="
              block
              w-full
              mt-1
              text-sm
              dark:border-gray-600
              dark:bg-gray-700
              focus:outline-none
            "
            type="text"
            id="edit-brand"
            x-model="updateData.brand"
            x-show="updateFor == 'brand'"
            @click.away="if (updateFor == 'brand') { updateFor = ''; }"
            @keydown.enter="updateBrand($dispatch)"
          />
        </dd>
      </div>
      <div class="px-4 py-1 sm:grid sm:grid-cols-2">
        <dt class="text-sm leading-5 font-medium text-gray-500">Kategori</dt>
        <dd class="mt-1 text-sm leading-5 text-gray-900 sm:mt-0">
          <div
            class="w-full"
            x-text="product.Category"
            @dblclick="openUpdateForCategory($nextTick);"
            x-show="updateFor !== 'category' && product.Category !== ''"
          ></div>
          <div
            class="w-full"
            @dblclick="openUpdateForCategory($nextTick);"
            x-show="updateFor !== 'category' && product.Category === ''"
          >
            -
          </div>
          <input
            class="
              block
              w-full
              mt-1
              text-sm
              dark:border-gray-600
              dark:bg-gray-700
              focus:outline-none
            "
            type="text"
            id="edit-category"
            x-model="updateData.category"
            x-show="updateFor == 'category'"
            @click.away="if (updateFor == 'category') { updateFor = ''; }"
            @keydown.enter="updateCategory($dispatch)"
          />
        </dd>
      </div>
      <!-- Deskripsi Produk -->
      <div class="px-4 py-1 sm:grid sm:grid-cols-2">
        <dt class="text-sm leading-5 font-medium text-gray-500">Deskripsi</dt>
        <dd class="mt-1 text-sm leading-5 text-gray-900 sm:mt-0">
          <div
            style="white-space: pre-line"
            class="w-full"
            x-text="product.Description"
            @dblclick="openUpdateForDescription($nextTick);"
            x-show="updateFor !== 'description' && product.Description !== ''"
          ></div>
          <div
            class="w-full"
            @dblclick="openUpdateForDescription($nextTick);"
            x-show="updateFor !== 'description' && product.Description === ''"
          >
            -
          </div>
          <textarea
            class="
              block
              w-full
              mt-1
              text-sm
              dark:border-gray-600
              dark:bg-gray-700
              focus:outline-none
            "
            type="text"
            id="edit-description"
            x-model="updateData.description"
            x-show="updateFor == 'description'"
            @click.away="if (updateFor == 'description') { updateFor = ''; updateDescription($dispatch); }"
            @keydown.enter="updateDescriptionEvent($event, $dispatch)"
          ></textarea>
        </dd>
      </div>
      <div class="px-4 py-1 sm:grid sm:grid-cols-2">
        <dt class="text-sm leading-5 font-medium text-gray-500">
          Tanggal Ditambahkan
        </dt>
        <dd
          class="mt-1 text-sm leading-5 text-gray-900 sm:mt-0"
          x-text="product.CreatedAt"
        ></dd>
      </div>
      <div class="px-4 py-1 sm:grid sm:grid-cols-2">
        <dt class="text-sm leading-5 font-medium text-gray-500">Stok</dt>
        <dd class="mt-1 text-sm leading-5 text-gray-900 sm:mt-0">
          <span
            x-text="`${product.Stock} Unit`"
            class="
              inline-block
              rounded-full
              px-3
              text-xs
              font-semibold
              cursor-pointer
            "
            :class="{'bg-red-200 text-red-500': product.Stock <= 20, 'bg-orange-200 text-orange-500': product.Stock > 20, 'bg-green-200 text-green-500': product.Stock > 100 }"
            @click="mpstock = !mpstock;"
          ></span>
        </dd>
      </div>
      <template x-if="mpstock">
        <div class="px-4 py-1 sm:grid sm:grid-cols-2">
          <dt class="text-sm leading-5 font-medium text-gray-500"></dt>
          <dd class="mt-1 text-sm leading-5 text-gray-900 sm:mt-0">
            <input
              class="
                block
                rounded-full
                w-full
                text-sm
                dark:border-gray-600
                dark:bg-gray-700
                focus:border-purple-400
                focus:outline-none
                focus:shadow-outline-purple
                dark:text-gray-300
                dark:focus:shadow-outline-gray
                form-input
              "
              placeholder="Tambah/kurangi stock: +100/-100"
              x-model="vmpstock"
              @keydown.enter="cmpstock($dispatch)"
            />
          </dd>
        </div>
      </template>
    </dl>

    <!-- Harga produk -->
    <dl class="w-full whitespace-no-wrap">
      <div
        class="
          text-xs
          font-semibold
          tracking-wide
          text-left text-gray-900
          uppercase
          border-b
          dark:border-gray-700
          bg-gray-50
          dark:text-gray-400
          dark:bg-gray-800
        "
      >
        <dt class="px-3 py-3">Harga Produk</dt>
        <dd class="px-4 sm:px-0"></dd>
      </div>
      <div class="px-4 py-1 sm:grid sm:grid-cols-2">
        <dt class="text-sm leading-5 font-medium text-gray-500">Beli</dt>
        <dd class="mt-1 text-sm leading-5 text-gray-900 sm:mt-0">
          <div
            class="w-full"
            x-text="toRupiah(product.BasePrice)"
            @dblclick="openUpdateForPriceBuy($nextTick);"
            x-show="updateFor !== 'price-buy'"
          ></div>
          <input
            class="
              block
              w-full
              mt-1
              text-sm
              dark:border-gray-600
              dark:bg-gray-700
              focus:outline-none
            "
            type="text"
            id="edit-price-buy"
            x-model="updateData.buy"
            x-show="updateFor == 'price-buy'"
            @click.away="if (updateFor == 'price-buy') { updateFor = ''; }"
            @keydown.enter="updatePriceBuy($dispatch)"
          />
        </dd>
      </div>
      <div class="px-4 py-1 sm:grid sm:grid-cols-2">
        <dt class="text-sm leading-5 font-medium text-gray-500">Jual</dt>
        <dd class="mt-1 text-sm leading-5 text-gray-900 sm:mt-0">
          <div
            class="w-full"
            x-text="toRupiah(product.Price)"
            @dblclick="openUpdateForPriceSell($nextTick);"
            x-show="updateFor !== 'price-sell'"
          ></div>
          <input
            class="
              block
              w-full
              mt-1
              text-sm
              dark:border-gray-600
              dark:bg-gray-700
              focus:outline-none
            "
            type="text"
            id="edit-price-sell"
            x-model="updateData.sell"
            x-show="updateFor == 'price-sell'"
            @click.away="if (updateFor == 'price-sell') { updateFor = ''; }"
            @keydown.enter="updatePriceSell($dispatch)"
          />
        </dd>
      </div>
    </dl>

    <!-- Harga Kredit -->
    <dl class="w-full whitespace-no-wrap">
      <div
        class="
          text-xs
          font-semibold
          tracking-wide
          text-left text-gray-900
          uppercase
          border-b
          dark:border-gray-700
          bg-gray-50
          dark:text-gray-400
          dark:bg-gray-800
        "
      >
        <dt class="px-3 py-3">Harga Kredit</dt>
        <dd class="px-4 sm:px-0"></dd>
      </div>
      <template x-for="(credit, index) in creditPrice" :key="index">
        <div
          class="cursor-pointer px-4 py-1 sm:grid sm:grid-cols-2 select-none"
          :class="{'hover:bg-green-200': selectedCP != credit.ID, 'bg-orange-200 hover:bg-orange-400': selectedCP == credit.ID }"
          @dblclick="if (selectedCP == credit.ID) { deleteCreditPrice($dispatch, credit.ID) }"
          @contextmenu.prevent="if (selectedCP != credit.ID) { selectedCP = credit.ID; } else { selectedCP = null; }"
        >
          <dt
            class="text-sm leading-5 font-medium text-gray-500"
            x-text="credit.Duration + ' bulan'"
          ></dt>
          <dd class="mt-1 text-sm leading-5 text-gray-900 sm:mt-0">
            <span
              class="text-sm font-semibold"
              x-text="`${toRupiah(credit.Price*credit.Duration)}`"
            ></span>
            <span
              class="text-xs text-orange-500"
              x-text="`(${toRupiah(credit.Price)} / bulan)`"
            ></span>
          </dd></div
      ></template>
      <span class="text-blue-700 dark:text-blue-400 text-sm px-4 pt-4">
        <a
          href="#"
          @click="Acpo()"
          x-text="isAcpo ? 'Batal' : 'Tambah harga kredit'"
          :class="{ 'text-red-500': isAcpo }"
        ></a
      ></span>
      <template x-if="isAcpo == true">
        <div class="w-full px-4">
          <label class="block text-sm">
            <div
              class="
                flex flex-wrap
                mt-1
                relative
                text-gray-500
                focus-within:text-purple-600
              "
            >
              <input
                class="
                  block
                  rounded-none rounded-l-sm
                  w-2/12
                  text-sm
                  dark:border-gray-600
                  dark:bg-gray-700
                  focus:border-purple-400
                  focus:outline-none
                  focus:shadow-outline-purple
                  dark:text-gray-300
                  dark:focus:shadow-outline-gray
                  form-input
                "
                placeholder="Tenor"
                x-model.number="addCreditPrice.duration"
                @keydown.enter="addCp($dispatch)"
              />
              <input
                class="
                  block
                  rounded-none
                  w-10/12
                  text-sm
                  dark:border-gray-600
                  dark:bg-gray-700
                  focus:border-purple-400
                  focus:outline-none
                  focus:shadow-outline-purple
                  dark:text-gray-300
                  dark:focus:shadow-outline-gray
                  form-input
                "
                placeholder="Cicilan per bulan"
                x-model.number="addCreditPrice.price"
                @keydown.enter="addCp($dispatch)"
              />
              <button
                class="
                  absolute
                  h-full
                  bottom-0
                  right-0
                  px-4
                  text-sm text-white
                  transition-colors
                  duration-150
                  bg-purple-600
                  border border-transparent
                  rounded-r-sm
                  active:bg-purple-600
                  hover:bg-purple-700
                  focus:outline-none
                  focus:shadow-outline-purple
                "
                @click="addCp($dispatch)"
              >
                tambah
              </button>
            </div>
          </label>
        </div>
      </template>
    </dl>
  </div>
</template>
<script>
  function fProDetail($parent) {
    return {
      id: $parent.modalTmp,
      addCreditPrice: {
        duration: null,
        price: null,
      },
      product: [],
      activeSlide: 1,
      photos: [
        {
          ID: 0,
          Photo: "no-photo.png",
        },
      ],
      addPhoto: {
        photos: [],
      },
      creditPrice: [],
      selectedCP: null,
      selectedPhoto: null,
      mpstock: false,
      vmpstock: null,
      // Update
      updateData: {
        name: "",
        brand: "",
        category: "",
        description: "",
        buy: null,
        sell: null,
      },
      updateFor: "",
      cmpstock($dispatch) {
        if (this.vmpstock == null) {
          $dispatch("notif", {
            type: "error",
            message: "Tentukan nilai stok",
          });
          return;
        }
        fetch(
          `/api/v1/local/product/edit/${this.id}/update/stock?set=${this.vmpstock}`,
          {
            method: "PATCH",
          }
        )
          .then((res) => res.json())
          .then((json) => {
            if (json.message) {
              $dispatch("notif", {
                type: json.status,
                message: json.message,
              });
            }

            if (json.status == "success") {
              if (this.vmpstock.substring(0, 1) == "-") {
                this.product.Stock -= this.vmpstock.substring(1);
              } else if (this.vmpstock.substring(0, 1) == "+") {
                this.product.Stock += Number(this.vmpstock.substring(1));
              } else {
                this.product.Stock += Number(this.vmpstock);
              }
            }
          })
          .catch((err) => {
            console.log("Error: cmpstock() " + err);
          });
      },
      fetchById($dispatch) {
        fetch(`/api/v1/local/product/id/${this.id}`, {
          method: "GET",
        })
          .then((res) => res.json())
          .then((json) => {
            if (json.error) {
              $dispatch("notif", {
                type: "error",
                message: json.error,
              });
            }

            if (json.product == null) {
              $dispatch("notif", {
                type: "error",
                message:
                  "Sepertinya telah terjadi kesalahan saat memuat data produk",
              });
            } else {
              this.product = json.product;
              if (json.product.CreditPrice != null) {
                this.creditPrice = json.product.CreditPrice;
              } else {
                this.creditPrice = [];
              }
              if (json.product.Photos != null) {
                this.photos = json.product.Photos;
              } else {
                this.photos = [
                  {
                    ID: 0,
                    Photo: "no-photo.png",
                  },
                ];
              }
            }
          })
          .catch((err) => {
            console.log(err);
          });
      },
      isAcpo: false,
      Acpo() {
        this.isAcpo = !this.isAcpo;
      },
      addCp($dispatch) {
        if (
          this.addCreditPrice.duration === null ||
          this.addCreditPrice.price === null
        ) {
          $dispatch("notif", {
            type: "error",
            message: "Tenor atau Tagiahan perbulan tidak boleh kosong",
          });
          return;
        }
        if (
          isNaN(this.addCreditPrice.duration) ||
          isNaN(this.addCreditPrice.price)
        ) {
          $dispatch("notif", {
            type: "error",
            message: "Tenor atau Tagiahan perbulan harus berupa angka",
          });
          return;
        }
        if (
          Number(this.addCreditPrice.duration) < 1 ||
          Number(this.addCreditPrice.price) < 1
        ) {
          $dispatch("notif", {
            type: "error",
            message: "Tenor atau Tagiahan perbulan harus berupa angka",
          });
          return;
        }

        for (i = 0; i < this.creditPrice.length; i++) {
          if (this.creditPrice[i].Duration == this.addCreditPrice.duration) {
            $dispatch("notif", {
              type: "error",
              message: `Harga untuk durasi ${this.addCreditPrice.duration} bulan sudah ditambahkan`,
            });
            return;
          }
        }

        fetch(`/api/v1/local/product/edit/${this.id}/add/credit_price`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(this.addCreditPrice),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.error) {
              $dispatch("notif", {
                type: "error",
                message: data.error,
              });
            }
            if (data.success) {
              $dispatch("notif", {
                type: "success",
                message: data.success,
              });
            }
            if (data.credit_price !== null) {
              this.creditPrice = data.credit_price;
            } else {
              this.creditPrice = [];
            }
          })
          .catch(() => {
            console.log("Telah terjadi kesalahan");
          });

        this.addCreditPrice.duration = null;
        this.addCreditPrice.price = null;
      },

      base64(file) {
        // Get file size
        var size =
          file.size > 1024
            ? file.size > 1048576
              ? Math.round(file.size / 1048576) + "mb"
              : Math.round(file.size / 1024) + "kb"
            : file.size + "b";
        var reader = new FileReader();
        _this = this;
        reader.onloadend = function () {
          var bsplit = reader.result.split(",");
          _this.addPhoto.photos.push({
            photo_type: bsplit[0],
            photo: bsplit[1],
            name: file.name,
            size: size,
          });
        };
        reader.readAsDataURL(file);
      },

      delPhoto(id) {
        this.addPhoto.photos.splice(id, 1);
      },

      addNewPhoto($dispatch) {
        if (this.addPhoto.photos.length === 0) {
          $dispatch("notif", {
            type: "error",
            message: "Tidak ada foto untuk diupload",
          });
          return;
        }
        fetch(`/api/v1/local/product/edit/${this.id}/add/photos`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(this.addPhoto),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.error) {
              $dispatch("notif", {
                type: "error",
                message: data.error,
              });
            }
            if (data.success) {
              $dispatch("notif", {
                type: "success",
                message: data.success,
              });
              this.addPhoto.photos = [];
              this.fetchById($dispatch);
            }
          })
          .catch(() => {
            console.log("Telah terjadi kesalahan");
          });
      },

      deleteCreditPriceData: {
        id: null,
      },
      deleteCreditPrice($dispatch, cpid) {
        this.deleteCreditPriceData.id = cpid;
        fetch(`/api/v1/local/product/edit/${this.id}/delete/credit_price`, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(this.deleteCreditPriceData),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.error) {
              $dispatch("notif", {
                type: "error",
                message: data.error,
              });
            }
            if (data.success) {
              $dispatch("notif", {
                type: "success",
                message: data.success,
              });
            }
            if (data.credit_price !== null) {
              this.creditPrice = data.credit_price;
            } else {
              this.creditPrice = [];
            }
          })
          .catch((err) => {
            console.log(err);
          });
      },

      deletePhotoData: {
        id: null,
      },
      deletePhoto($dispatch, index) {
        this.deletePhotoData.id = this.selectedPhoto;
        fetch(`/api/v1/local/product/edit/${this.id}/delete/photo`, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(this.deletePhotoData),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.error) {
              $dispatch("notif", {
                type: "error",
                message: data.error,
              });
            }
            if (data.success) {
              $dispatch("notif", {
                type: "success",
                message: data.success,
              });

              this.selectedPhoto = null;
              this.photos.splice(index, 1);
              if (this.photos.length == 0) {
                this.photos = [
                  {
                    ID: 0,
                    Photo: "no-photo.png",
                  },
                ];
              }
              if (this.activeSlide > 1) {
                this.activeSlide = this.activeSlide - 1;
              }
            }
          })
          .catch((err) => {
            console.log(err);
          });
      },

      openUpdateForName($nextTick) {
        this.updateFor = "name";
        this.updateData.name = this.product.Name;
        $nextTick(() => {
          document.getElementById(`edit-name`).select();
        });
      },

      openUpdateForBrand($nextTick) {
        this.updateFor = "brand";
        this.updateData.brand = this.product.Brand;
        $nextTick(() => {
          document.getElementById(`edit-brand`).select();
        });
      },

      openUpdateForCategory($nextTick) {
        this.updateFor = "category";
        this.updateData.category = this.product.Category;
        $nextTick(() => {
          document.getElementById(`edit-category`).select();
        });
      },

      openUpdateForDescription($nextTick) {
        this.updateFor = "description";
        this.updateData.description = this.product.Description;
        $nextTick(() => {
          document.getElementById(`edit-description`).select();
        });
      },

      openUpdateForPriceBuy($nextTick) {
        this.updateFor = "price-buy";
        this.updateData.buy = this.product.BasePrice;
        $nextTick(() => {
          document.getElementById(`edit-price-buy`).select();
        });
      },

      openUpdateForPriceSell($nextTick) {
        this.updateFor = "price-sell";
        this.updateData.sell = this.product.Price;
        $nextTick(() => {
          document.getElementById(`edit-price-sell`).select();
        });
      },

      updateName($dispatch) {
        if (this.updateData.name.length < 1) {
          $dispatch("notif", {
            type: "error",
            message: "Nama produk tidak boleh kosong",
          });
          return;
        }
        fetch(
          `/api/v1/local/product/edit/${
            this.id
          }/update/name?set=${encodeURIComponent(this.updateData.name)}`,
          {
            method: "PATCH",
          }
        )
          .then((res) => res.json())
          .then((json) => {
            if (json.message) {
              $dispatch("notif", {
                type: json.status,
                message: json.message,
              });
            }
            if (json.status == "success") {
              product = document.getElementById("product_data").__x.$data;
              product.fetchProductsData($dispatch, false, "reload", true);
              this.product.Name = this.updateData.name;
            }
          })
          .catch((err) => {
            console.log("Error: updateName() " + err);
          });
      },

      updateBrand($dispatch) {
        if (this.updateData.brand.length < 1) {
          $dispatch("notif", {
            type: "error",
            message: "Brand produk tidak boleh kosong",
          });
          return;
        }
        fetch(
          `/api/v1/local/product/edit/${
            this.id
          }/update/brand?set=${encodeURIComponent(this.updateData.brand)}`,
          {
            method: "PATCH",
          }
        )
          .then((res) => res.json())
          .then((json) => {
            if (json.message) {
              $dispatch("notif", {
                type: json.status,
                message: json.message,
              });
            }
            if (json.status == "success") {
              product = document.getElementById("product_data").__x.$data;
              product.fetchProductsData($dispatch, false, "reload", true);
              this.product.Brand = this.updateData.brand;
            }
          })
          .catch((err) => {
            console.log("Error: updateBrand() " + err);
          });
      },

      updateCategory($dispatch) {
        if (this.updateData.category.length < 1) {
          $dispatch("notif", {
            type: "error",
            message: "Kategori produk tidak boleh kosong",
          });
          return;
        }
        fetch(
          `/api/v1/local/product/edit/${
            this.id
          }/update/category?set=${encodeURIComponent(
            this.updateData.category
          )}`,
          {
            method: "PATCH",
          }
        )
          .then((res) => res.json())
          .then((json) => {
            if (json.message) {
              $dispatch("notif", {
                type: json.status,
                message: json.message,
              });
            }
            if (json.status == "success") {
              product = document.getElementById("product_data").__x.$data;
              product.fetchProductsData($dispatch, false, "reload", true);
              this.product.Category = this.updateData.category;
            }
          })
          .catch((err) => {
            console.log("Error: updateCategory() " + err);
          });
      },

      updateDescriptionEvent($event, $dispatch) {
        if ($event.ctrlKey) {
          this.updateDescription($dispatch);
        }
      },

      updateDescription($dispatch) {
        if (this.updateData.description.length < 1) {
          $dispatch("notif", {
            type: "error",
            message: "Deskripsi produk tidak boleh kosong",
          });
          return;
        }
        fetch(
          `/api/v1/local/product/edit/${
            this.id
          }/update/description?set=${encodeURIComponent(
            this.updateData.description
          )}`,
          {
            method: "PATCH",
          }
        )
          .then((res) => res.json())
          .then((json) => {
            if (json.message) {
              $dispatch("notif", {
                type: json.status,
                message: json.message,
              });
            }
            if (json.status == "success") {
              product = document.getElementById("product_data").__x.$data;
              product.fetchProductsData($dispatch, false, "reload", true);
              this.product.Description = this.updateData.description;
            }
          })
          .catch((err) => {
            console.log("Error: updateDescription() " + err);
          });
      },

      updatePriceBuy($dispatch) {
        if (this.updateData.buy.length < 1) {
          $dispatch("notif", {
            type: "error",
            message: "Harga beli produk tidak boleh kosong",
          });
          return;
        }
        fetch(
          `/api/v1/local/product/edit/${this.id}/update/price/buy?set=${this.updateData.buy}`,
          {
            method: "PATCH",
          }
        )
          .then((res) => res.json())
          .then((json) => {
            if (json.message) {
              $dispatch("notif", {
                type: json.status,
                message: json.message,
              });
            }
            if (json.status == "success") {
              product = document.getElementById("product_data").__x.$data;
              product.fetchProductsData($dispatch, false, "reload", true);
              this.product.BasePrice = this.updateData.buy;
            }
          })
          .catch((err) => {
            console.log("Error: updatePriceBuy() " + err);
          });
      },

      updatePriceSell($dispatch) {
        if (this.updateData.sell.length < 1) {
          $dispatch("notif", {
            type: "error",
            message: "Harga beli produk tidak boleh kosong",
          });
          return;
        }
        fetch(
          `/api/v1/local/product/edit/${this.id}/update/price/sell?set=${this.updateData.sell}`,
          {
            method: "PATCH",
          }
        )
          .then((res) => res.json())
          .then((json) => {
            if (json.message) {
              $dispatch("notif", {
                type: json.status,
                message: json.message,
              });
            }
            if (json.status == "success") {
              product = document.getElementById("product_data").__x.$data;
              product.fetchProductsData($dispatch, false, "reload", true);
              this.product.Price = this.updateData.sell;
            }
          })
          .catch((err) => {
            console.log("Error: updatePriceSell() " + err);
          });
      },
    };
  }
</script>
{{ end }}
